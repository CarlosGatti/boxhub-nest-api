generator client {
  provider = "prisma-client-js"
}

generator nestgraphql {
  provider = "node node_modules/prisma-nestjs-graphql"
  output   = "../@generated"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Storage {
  id         Int             @id @default(autoincrement())
  name       String
  members    StorageMember[] // ← Relacionamento M:N com usuários
  containers Container[]
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
}

model StorageMember {
  id        Int         @id @default(autoincrement())
  userId    Int
  storageId Int
  role      StorageRole @default(MEMBER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  storage Storage @relation(fields: [storageId], references: [id])

  @@unique([userId, storageId])
}

model Container {
  id          Int        @id @default(autoincrement())
  name        String
  description String
  qrCode      String // QR Code para identificação
  code        String     @unique // Código para identificação adicional
  storageId   Int
  storage     Storage    @relation(fields: [storageId], references: [id])
  categories  Category[] @relation("ContainerCategories")
  items       Item[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Item {
  id          Int       @id @default(autoincrement())
  name        String
  description String
  imageUrl    String // URL para a imagem do item
  quantity    Int
  category    String // Categoria adicional, se necessário
  containerId Int
  container   Container @relation(fields: [containerId], references: [id])

  // Transição para Discart-me
  donatedToDiscartMe Boolean   @default(false) // Indica se o item foi doado no Discart-me
  discartItemId      Int? // ID do DiscartItem criado quando doado
  donatedAt          DateTime? // Data em que foi doado

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DiscartItem {
  id          Int                  @id @default(autoincrement())
  title       String
  description String
  type        DiscartItemType
  price       Float?
  category    DiscartItemCategory  @default(OTHER)
  condition   DiscartItemCondition
  status      DiscartItemStatus    @default(ACTIVE)

  imageUrls     String[] @default([])
  pickupAddress Json? // { condoName, building, unit, notes }
  contactPhone  String? // ← agora opcional

  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])

  comments Comment[] // Comments on this item

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id          Int         @id @default(autoincrement())
  name        String
  description String?
  containers  Container[] @relation("ContainerCategories")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model User {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  password       String
  firstName      String
  lastName       String
  nickname       String?
  public         Boolean   @default(false)
  role           Role      @default(USER)
  emailVerified  Boolean   @default(false)
  profilePicture String?
  about          String?
  contactPhone   String? // ← NOVO CAMPO
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  isPremium      Boolean   @default(false)
  subscriptionId String? // LemonSqueezy ID
  expiresAt      DateTime?
  willExpireAt   DateTime? // Expiração futura agendada

  // Discart-me specific
  apartment          String?
  isApprovedResident Boolean @default(false)
  isAdmin            Boolean @default(false)

  storageMemberships StorageMember[]
  logs               Log[]

  discartItems DiscartItem[]

  // Comments and Ratings
  comments        Comment[] @relation("CommentAuthor")
  ratingsAsSeller Rating[]  @relation("SellerRatings")
  ratingsAsBuyer  Rating[]  @relation("BuyerRatings")

  // Multi-app access
  apps UserAppAccess[]

  // Feedback / Evaluation
  feedbacks Feedback[]

  // HomeOps
  homeOpsHouseholdsOwned        HomeOpsHousehold[]       @relation("HomeOpsHouseholdOwner")
  homeOpsHouseholdMemberships   HomeOpsHouseholdMember[]
  homeOpsTaskTemplatesCreated   HomeOpsTaskTemplate[]    @relation("HomeOpsTemplateCreator")
  homeOpsTaskTemplatesAssigned  HomeOpsTaskTemplate[]    @relation("HomeOpsTemplateAssignee")
  homeOpsTaskInstancesAssigned  HomeOpsTaskInstance[]    @relation("HomeOpsInstanceAssignee")
  homeOpsTaskInstancesCompleted HomeOpsTaskInstance[]    @relation("HomeOpsInstanceCompletedBy")
  homeOpsWorkloadLedgers        HomeOpsWorkloadLedger[]

  // SignalBoard
  feedProfile           FeedProfile?
  feedItemStates        FeedItemState[]
  feedEvents            FeedEvent[]
  feedSourceNudges      FeedSourceNudge[]
  feedSourcePreferences FeedSourcePreference[]

  // Wealth Tracker
  portfolios Portfolio[] @relation("UserPortfolios")

  // Cash Flow
  cashflowCategories CashflowCategory[]
  cashflowEntries    CashflowEntry[]
  recurringCashflows RecurringCashflow[]

  // Review Cards
  reviewCardBusinesses      ReviewCardBusiness[]
  reviewCardProjects        ReviewCardProject[]
  reviewCardPremiumRequests ReviewCardPremiumRequest[]

  // Bucket List (goals + memories)
  bucketGoals BucketGoal[]
  bucketShares BucketShare[]

  // Bucket Vision Board
  bucketVisionBoards BucketVisionBoard[]

  @@index([email], map: "userEmail")
}

model Log {
  id        Int       @id @default(autoincrement())
  action    LogAction
  userId    Int?
  user      User?     @relation(fields: [userId], references: [id])
  details   String?
  route     String? // Rota acessada (ex: "/dashboard" ou "/item/:id")
  metadata  Json? // Dados adicionais sobre o evento (ex: { itemId: 123, buttonName: "BuyNow" })
  ipAddress String?
  createdAt DateTime  @default(now())
}

enum LogAction {
  USER_LOGIN
  USER_LOGOUT
  ITEM_CREATED
  ITEM_UPDATED
  ITEM_DELETED
  CONTAINER_CREATED
  CONTAINER_DELETED
  BUTTON_CLICKED
  PAGE_VIEWED
  SEARCH_USED
  CUSTOM_ACTION
  REQUEST_PASSWORD_RESET
  PASSWORD_RESET
  USER_REGISTERED
  USER_PROFILE_UPDATED
  USER_DELETED
  STORAGE_CREATED
  STORAGE_DELETED
}

enum FeedbackStatus {
  PENDING
  PUBLISHED
  HIDDEN
  SPAM
}

enum HouseholdRole {
  OWNER
  ADMIN
  MEMBER
}

enum HomeOpsAssignmentMode {
  FIXED
  ROUND_ROBIN
  BALANCED
}

enum HomeOpsTaskStatus {
  OPEN
  DONE
  SKIPPED
  CARRIED
}

enum HomeOpsWeeklyPlanStatus {
  PLANNED
  ACTIVE
  ARCHIVED
}

enum HomeOpsWeekday {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum HomeOpsFrequency {
  ONCE
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
}

enum ReviewCardProjectStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ReviewCardLinkMode {
  DIRECT
  REDIRECT
}

enum ReviewCardExportType {
  PNG
  PDF
}

enum ReviewCardExportStatus {
  QUEUED
  DONE
  FAILED
}

enum ReviewCardPremiumRequestStatus {
  OPEN
  IN_PROGRESS
  DELIVERED
}

enum FeedSourceType {
  RSS
  YOUTUBE_CHANNEL
  YOUTUBE_PLAYLIST
  GOOGLE_NEWS_RSS
  CUSTOM
}

enum FeedItemType {
  ARTICLE
  VIDEO
  POST
}

enum FeedItemStatus {
  ACTIVE
  REMOVED
}

enum FeedItemReadStatus {
  UNREAD
  READ
}

enum FeedItemSaveStatus {
  NONE
  SAVED
}

enum FeedItemVisibility {
  VISIBLE
  HIDDEN
}

enum FeedEventAction {
  OPENED
  SKIPPED
}

enum FeedItemLastAction {
  OPEN
  READ
  SKIP
  SAVE
  HIDE
}

enum Role {
  USER
  ADMIN
}

enum DiscartItemType {
  SELL
  DONATE
}

enum DiscartItemCondition {
  NEW
  LIKE_NEW
  USED
}

enum DiscartItemStatus {
  ACTIVE
  RESERVED
  SOLD
  DONATED // ← NOVO STATUS
}

enum DiscartItemCategory {
  FURNITURE
  ELECTRONICS
  KIDS
  SPORTS
  OTHER
  BOOK
}

enum Visibility {
  PUBLIC
  PRIVATE
}

enum MembershipStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELED
}

enum TypeOfDeparture {
  VOLUNTARY
  INVOLUNTARY
  RETIREMENT
  OTHER // Quando selecionado "Outro", o campo `otherDetails` pode ser usado para especificação
}

enum StorageRole {
  ADMIN
  MEMBER
}

model Comment {
  id            Int      @id @default(autoincrement())
  content       String
  discartItemId Int
  userId        Int
  parentId      Int? // For replies (nested comments)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  discartItem DiscartItem @relation(fields: [discartItemId], references: [id], onDelete: Cascade)
  user        User        @relation("CommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  parent      Comment?    @relation("CommentParent", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[]   @relation("CommentParent")

  @@index([discartItemId])
  @@index([userId])
  @@index([parentId])
}

model Rating {
  id        Int      @id @default(autoincrement())
  sellerId  Int
  buyerId   Int
  stars     Int // 1-5
  comment   String?
  createdAt DateTime @default(now())

  seller User @relation("SellerRatings", fields: [sellerId], references: [id], onDelete: Cascade)
  buyer  User @relation("BuyerRatings", fields: [buyerId], references: [id], onDelete: Cascade)

  @@unique([sellerId, buyerId]) // Prevent duplicate ratings
  @@index([sellerId])
  @@index([buyerId])
}

model App {
  id                Int                @id @default(autoincrement())
  code              String             @unique
  name              String
  description       String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  users             UserAppAccess[]
  feedbacks         Feedback[]
  homeOpsHouseholds HomeOpsHousehold[] @relation("HomeOpsHouseholdApp")
}

model UserAppAccess {
  id        Int      @id @default(autoincrement())
  userId    Int
  appId     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  app       App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@unique([userId, appId])
  @@index([userId])
  @@index([appId])
}

// ============================================
// Feedback / Evaluation
// ============================================

model Feedback {
  id Int @id @default(autoincrement())

  // Which app/project is being reviewed
  targetAppId Int
  targetApp   App @relation(fields: [targetAppId], references: [id], onDelete: Cascade)

  // Actor (either logged user or anonymous)
  userId Int?
  user   User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  anonymousId  String?
  contactEmail String?

  // Feedback content
  rating      Int?
  message     String
  tags        String[] @default([])
  contextPath String?
  metadata    Json?

  status FeedbackStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([targetAppId])
  @@index([userId])
  @@index([anonymousId])
  @@index([status])
  @@index([createdAt])
  @@index([targetAppId, createdAt])
  @@index([targetAppId, status, createdAt])
}

// ============================================
// HomeOps Models
// ============================================

model HomeOpsHousehold {
  id        Int      @id @default(autoincrement())
  name      String
  ownerId   Int
  appId     Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner           User                     @relation("HomeOpsHouseholdOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  app             App?                     @relation("HomeOpsHouseholdApp", fields: [appId], references: [id], onDelete: SetNull)
  members         HomeOpsHouseholdMember[]
  templates       HomeOpsTaskTemplate[]
  taskInstances   HomeOpsTaskInstance[]
  workloadLedgers HomeOpsWorkloadLedger[]
  weeklyPlans     HomeOpsWeeklyPlan[]

  @@index([ownerId])
  @@index([appId])
}

model HomeOpsHouseholdMember {
  id          Int           @id @default(autoincrement())
  householdId Int
  userId      Int
  role        HouseholdRole @default(MEMBER)
  joinedAt    DateTime      @default(now())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  household HomeOpsHousehold @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([householdId, userId])
  @@index([userId])
}

model HomeOpsTaskTemplate {
  id               Int                   @id @default(autoincrement())
  householdId      Int
  title            String
  description      String?
  category         String?
  points           Int                   @default(1)
  effortWeight     Int                   @default(1)
  estimatedMinutes Int?
  frequency        HomeOpsFrequency
  occurrences      Int?
  interval         Int?
  daysOfWeek       HomeOpsWeekday[]      @default([])
  dayOfMonth       Int?
  timezone         String                @default("America/Denver")
  assignmentMode   HomeOpsAssignmentMode @default(FIXED)
  fixedAssigneeId  Int?
  isActive         Boolean               @default(true)
  createdById      Int
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  household     HomeOpsHousehold          @relation(fields: [householdId], references: [id], onDelete: Cascade)
  createdBy     User                      @relation("HomeOpsTemplateCreator", fields: [createdById], references: [id], onDelete: Restrict)
  fixedAssignee User?                     @relation("HomeOpsTemplateAssignee", fields: [fixedAssigneeId], references: [id], onDelete: SetNull)
  slots         HomeOpsTaskTemplateSlot[]
  taskInstances HomeOpsTaskInstance[]

  @@index([householdId])
  @@index([isActive])
}

model HomeOpsTaskTemplateSlot {
  id          Int    @id @default(autoincrement())
  templateId  Int
  label       String
  windowStart String
  windowEnd   String
  order       Int

  template HomeOpsTaskTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, order])
  @@index([templateId])
}

model HomeOpsTaskInstance {
  id               Int               @id @default(autoincrement())
  householdId      Int
  templateId       Int?
  weeklyPlanId     Int?
  sourceKey        String?
  title            String
  description      String?
  category         String?
  points           Int               @default(1)
  effortWeight     Int               @default(1)
  estimatedMinutes Int?
  dueDate          DateTime
  slotLabel        String?
  windowStart      String?
  windowEnd        String?
  assigneeId       Int?
  status           HomeOpsTaskStatus @default(OPEN)
  completedAt      DateTime?
  completedById    Int?
  skippedAt        DateTime?
  skipReason       String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  household   HomeOpsHousehold     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  template    HomeOpsTaskTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  weeklyPlan  HomeOpsWeeklyPlan?   @relation(fields: [weeklyPlanId], references: [id], onDelete: SetNull)
  assignee    User?                @relation("HomeOpsInstanceAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  completedBy User?                @relation("HomeOpsInstanceCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)

  @@unique([weeklyPlanId, sourceKey])
  @@index([householdId])
  @@index([dueDate])
  @@index([status])
  @@index([assigneeId])
  @@index([weeklyPlanId])
}

model HomeOpsWeeklyPlan {
  id            Int                     @id @default(autoincrement())
  householdId   Int
  weekStartDate DateTime
  status        HomeOpsWeeklyPlanStatus @default(PLANNED)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  household HomeOpsHousehold      @relation(fields: [householdId], references: [id], onDelete: Cascade)
  tasks     HomeOpsTaskInstance[]

  @@unique([householdId, weekStartDate])
  @@index([householdId])
}

model HomeOpsWorkloadLedger {
  id               Int      @id @default(autoincrement())
  householdId      Int
  userId           Int
  weekStart        DateTime
  pointsCompleted  Int      @default(0)
  minutesCompleted Int      @default(0)
  tasksCompleted   Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  household HomeOpsHousehold @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([householdId, userId, weekStart])
  @@index([householdId])
  @@index([userId])
}

// ============================================
// Review Cards Models
// ============================================

model ReviewCardBusiness {
  id              Int      @id @default(autoincrement())
  userId          Int
  name            String
  placeId         String?
  googleReviewUrl String?
  website         String?
  phone           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user     User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects ReviewCardProject[]

  @@index([userId])
}

model ReviewCardTemplate {
  id                 Int      @id @default(autoincrement())
  key                String   @unique
  name               String
  category           String
  aspect             String
  schemaVersion      Int
  isActive           Boolean  @default(true)
  previewImageUrl    String?
  defaultDesignJson  Json
  editableFieldsJson Json
  constraintsJson    Json
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  projects ReviewCardProject[]

  @@index([isActive])
  @@index([aspect])
  @@index([category])
}

model ReviewCardProject {
  id                   Int                     @id @default(autoincrement())
  userId               Int
  businessId           Int
  templateId           Int
  name                 String
  slug                 String?                 @unique
  status               ReviewCardProjectStatus @default(DRAFT)
  reviewLinkMode       ReviewCardLinkMode      @default(REDIRECT)
  googleReviewUrlFinal String?
  designJson           Json?
  assetsJson           Json?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt

  user            User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  business        ReviewCardBusiness         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  template        ReviewCardTemplate         @relation(fields: [templateId], references: [id], onDelete: Restrict)
  exports         ReviewCardExport[]
  scans           ReviewCardScanEvent[]
  premiumRequests ReviewCardPremiumRequest[]

  @@index([userId])
  @@index([businessId])
  @@index([templateId])
  @@index([status])
}

model ReviewCardExport {
  id           Int                    @id @default(autoincrement())
  projectId    Int
  type         ReviewCardExportType
  format       String
  status       ReviewCardExportStatus @default(QUEUED)
  fileUrl      String?
  errorMessage String?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  project ReviewCardProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
}

model ReviewCardScanEvent {
  id        Int      @id @default(autoincrement())
  projectId Int
  ipHash    String?
  userAgent String?
  referer   String?
  createdAt DateTime @default(now())

  project ReviewCardProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([createdAt])
  @@index([projectId, createdAt])
}

model ReviewCardPremiumRequest {
  id        Int                            @id @default(autoincrement())
  userId    Int
  projectId Int?
  notes     String
  status    ReviewCardPremiumRequestStatus @default(OPEN)
  createdAt DateTime                       @default(now())
  updatedAt DateTime                       @updatedAt

  user    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  project ReviewCardProject? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([projectId])
  @@index([status])
}

// ============================================
// SignalBoard Models
// ============================================

model FeedProfile {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  timezone  String?
  language  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  collections FeedCollection[]

  @@index([userId])
}

model FeedCollection {
  id               Int      @id @default(autoincrement())
  profileId        Int
  name             String
  description      String?
  icon             String?
  color            String?
  keywords         String[] @default([])
  blocked          String[] @default([])
  preferredDomains String[] @default([])
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  profile FeedProfile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  sources FeedSource[]

  @@unique([profileId, name])
  @@index([profileId])
  @@index([isActive])
}

model FeedSource {
  id            Int            @id @default(autoincrement())
  collectionId  Int
  type          FeedSourceType
  name          String
  url           String
  isActive      Boolean        @default(true)
  includeShorts Boolean        @default(false)
  fetchEveryMin Int?
  lastFetchedAt DateTime?
  failureCount  Int            @default(0)
  metadata      Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  collection  FeedCollection    @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  items       FeedItem[]
  events      FeedEvent[]
  nudges      FeedSourceNudge[]
  preferences FeedSourcePreference[]

  @@index([collectionId])
  @@index([isActive])
  @@index([type])
}

model FeedItem {
  id           Int            @id @default(autoincrement())
  sourceId     Int
  type         FeedItemType   @default(ARTICLE)
  status       FeedItemStatus @default(ACTIVE)
  title        String
  canonicalUrl String?
  publishedAt  DateTime?
  contentText  String?
  imageUrl     String?
  metrics      Json?
  contentHash  String         @unique
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  source  FeedSource       @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  states  FeedItemState[]
  summary FeedItemSummary?
  events  FeedEvent[]

  @@index([sourceId])
  @@index([publishedAt])
}

model FeedItemState {
  id         Int                @id @default(autoincrement())
  userId     Int
  itemId     Int
  readStatus FeedItemReadStatus @default(UNREAD)
  saveStatus FeedItemSaveStatus @default(NONE)
  visibility FeedItemVisibility @default(VISIBLE)
  openedAt   DateTime?
  skippedAt  DateTime?
  skipCount  Int                @default(0)
  actionCount Int               @default(0)
  lastAction FeedItemLastAction?
  readAt     DateTime?
  savedAt    DateTime?
  hiddenAt   DateTime?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  item FeedItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@index([userId])
  @@index([itemId])
}

model FeedItemSummary {
  id        Int      @id @default(autoincrement())
  itemId    Int      @unique
  summary   String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  item FeedItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

model FeedEvent {
  id        Int             @id @default(autoincrement())
  userId    Int
  itemId    Int
  sourceId  Int
  action    FeedEventAction
  createdAt DateTime        @default(now())

  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  item   FeedItem   @relation(fields: [itemId], references: [id], onDelete: Cascade)
  source FeedSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([userId, sourceId, createdAt])
  @@index([userId, itemId, createdAt])
}

model FeedSourceNudge {
  id        Int      @id @default(autoincrement())
  userId    Int
  sourceId  Int
  reason    String
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  source FeedSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([userId, sourceId, status])
}

model FeedSourcePreference {
  id               Int      @id @default(autoincrement())
  userId           Int
  sourceId         Int
  notifyOnNew      Boolean  @default(false)
  isMuted          Boolean  @default(false)
  mutedUntil       DateTime?
  consecutiveSkips Int      @default(0)
  lastInteractedAt DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  source FeedSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([userId, sourceId])
  @@index([userId])
  @@index([sourceId])
  @@index([consecutiveSkips])
}

// ============================================
// Wealth Tracker Models
// ============================================

model Portfolio {
  id           Int           @id @default(autoincrement())
  userId       Int
  name         String
  baseCurrency String        @default("USD")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User          @relation("UserPortfolios", fields: [userId], references: [id], onDelete: Cascade)
  holdings     Holding[]
  transactions Transaction[]

  @@index([userId])
}

model Asset {
  id           Int           @id @default(autoincrement())
  type         AssetType
  ticker       String? // Nullable for CASH/REAL_ESTATE
  name         String
  currency     String        @default("USD")
  exchange     String?
  metadata     Json? // Additional metadata (e.g., sector, market cap)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  holdings     Holding[]
  pricePoints  PricePoint[]
  transactions Transaction[] @relation("AssetTransactions")

  @@unique([type, ticker], name: "unique_asset_ticker")
  @@index([ticker])
  @@index([type])
}

model Holding {
  id          Int       @id @default(autoincrement())
  portfolioId Int
  assetId     Int
  quantity    Decimal   @db.Decimal(20, 8)
  averageCost Decimal   @db.Decimal(20, 8)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  asset       Asset     @relation(fields: [assetId], references: [id], onDelete: Restrict)

  @@index([portfolioId])
  @@index([assetId])
}

model PricePoint {
  id        Int      @id @default(autoincrement())
  assetId   Int
  price     Decimal  @db.Decimal(20, 8)
  currency  String
  asOf      DateTime
  source    String // Provider name (e.g., "mock", "yahoo")
  createdAt DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, asOf])
  @@index([assetId, asOf])
  @@index([asOf])
}

model Transaction {
  id          Int             @id @default(autoincrement())
  portfolioId Int
  assetId     Int
  type        TransactionType
  quantity    Decimal         @db.Decimal(20, 8)
  price       Decimal         @db.Decimal(20, 8)
  fees        Decimal?        @db.Decimal(20, 8)
  notes       String?
  executedAt  DateTime        @default(now())
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  portfolio   Portfolio       @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  asset       Asset           @relation("AssetTransactions", fields: [assetId], references: [id], onDelete: Restrict)

  @@index([portfolioId])
  @@index([assetId])
  @@index([executedAt])
}

enum AssetType {
  STOCK
  ETF
  CRYPTO
  CASH
  REAL_ESTATE
}

enum TransactionType {
  BUY
  SELL
}

enum CashflowType {
  INCOME
  EXPENSE
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model CashflowCategory {
  id          Int                 @id @default(autoincrement())
  userId      Int
  name        String
  type        CashflowType
  description String?
  color       String? // Hex color for UI
  icon        String? // Icon identifier
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries     CashflowEntry[]
  recurring   RecurringCashflow[]

  @@unique([userId, name, type])
  @@index([userId, type])
}

model CashflowEntry {
  id          Int              @id @default(autoincrement())
  userId      Int
  categoryId  Int
  type        CashflowType
  amount      Decimal          @db.Decimal(20, 2)
  source      String? // Origin/source: "Netflix", "Trader Joes", "Salary Company", etc.
  description String?
  date        DateTime         @default(now())
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    CashflowCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([categoryId])
  @@index([date])
  @@index([type])
  @@index([source])
}

model RecurringCashflow {
  id          Int                 @id @default(autoincrement())
  userId      Int
  categoryId  Int
  type        CashflowType
  amount      Decimal             @db.Decimal(20, 2)
  source      String? // Origin/source: "Netflix", "Trader Joes", "Salary Company", etc.
  description String?
  frequency   RecurrenceFrequency
  startDate   DateTime
  endDate     DateTime? // Null means ongoing
  nextDueDate DateTime
  notes       String?
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    CashflowCategory    @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([categoryId])
  @@index([nextDueDate])
  @@index([isActive])
  @@index([source])
}

// ============================================
// Bucket List (Goals + Memories)
// ============================================

enum BucketGoalType {
  GENERAL
  TRAVEL
  EVENT
  PLACE_COLLECTION
  ACHIEVEMENT
  // Specialized goal categories for dedicated frontend views
  GAME
  MOVIE
  TV_SHOW
  BOOK
}

enum BucketGoalStatus {
  IDEA
  PLANNED
  IN_PROGRESS
  DONE
  DROPPED
}

enum BucketPinSource {
  MANUAL
  NOMINATIM
  GOOGLE
}

enum BucketMediaType {
  IMAGE
  VIDEO
  LINK
}

enum BucketShareType {
  GOAL
  TYPE
  CUSTOM
}

model BucketShare {
  id        Int            @id @default(autoincrement())
  userId    Int
  token     String         @unique
  type      BucketShareType
  payload   Json
  createdAt DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model BucketGoal {
  id                    Int             @id @default(autoincrement())
  userId                Int
  title                 String
  description           String?
  type                  BucketGoalType  @default(GENERAL)
  status                BucketGoalStatus @default(IDEA)
  priority              Int             @default(0)
  details               Json?
  detailsSchemaVersion  Int             @default(1)
  coverUrl              String?
  tags                  String[]        @default([])
  targetDate            DateTime?
  completedAt           DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs  BucketGoalLog[]
  pins  BucketGoalPin[]
  media BucketGoalMedia[]

  bucketVisionGoalLinks BucketVisionGoalLink[]

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([userId, type])
  @@index([userId, status])
  @@index([userId, createdAt])
}

model BucketGoalLog {
  id         Int       @id @default(autoincrement())
  goalId     Int
  note       String
  happenedAt DateTime
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  goal   BucketGoal      @relation(fields: [goalId], references: [id], onDelete: Cascade)
  media  BucketGoalMedia[]

  @@index([goalId])
  @@index([happenedAt])
  @@index([goalId, happenedAt])
}

model BucketGoalPin {
  id       Int            @id @default(autoincrement())
  goalId   Int
  lat      Float
  lng      Float
  label    String?
  source   BucketPinSource @default(MANUAL)
  placeId  String?
  address  String?
  raw      Json?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  goal BucketGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@index([source])
  @@index([goalId, lat, lng])
}

model BucketGoalMedia {
  id       Int           @id @default(autoincrement())
  goalId   Int?
  logId    Int?
  url      String
  type     BucketMediaType @default(IMAGE)
  metadata Json?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  goal BucketGoal?    @relation(fields: [goalId], references: [id], onDelete: Cascade)
  log  BucketGoalLog? @relation(fields: [logId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@index([logId])
}

// ============================================
// Bucket Vision Board (guided prompts + visual inspiration)
// ============================================

enum BucketVisionPeriodType {
  YEAR
  QUARTER
  CUSTOM
}

enum BucketVisionSectionType {
  LIFE_WELLBEING
  SCHOOL_LEARNING
  DREAM_BIG
  CAREER_GROWTH
  VISUAL_INSPIRATION
  CUSTOM
}

enum BucketVisionItemType {
  IMAGE
  QUOTE
  COLOR
  LINK
  GOAL_REF
}

enum BucketVisionLayoutMode {
  FORM
  CANVAS
}

model BucketVisionBoard {
  id         Int                   @id @default(autoincrement())
  userId     Int
  title      String                @default("Your Vision Board")
  periodType BucketVisionPeriodType @default(YEAR)
  year       Int?
  periodKey  String?
  startDate  DateTime?
  endDate    DateTime?
  theme      String?
  layoutMode BucketVisionLayoutMode @default(FORM)
  coverUrl   String?
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt

  user     User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  sections BucketVisionSection[]
  items    BucketVisionItem[]
  goalLinks BucketVisionGoalLink[]
  checkins BucketVisionCheckin[]

  @@unique([userId, year])
  @@index([userId])
  @@index([userId, year])
  @@index([userId, periodKey])
}

model BucketVisionSection {
  id        Int                   @id @default(autoincrement())
  boardId   Int
  type      BucketVisionSectionType
  title     String?
  content   Json?
  order     Int                   @default(0)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  board BucketVisionBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@unique([boardId, type])
  @@index([boardId])
}

model BucketVisionItem {
  id       Int            @id @default(autoincrement())
  boardId  Int
  type     BucketVisionItemType
  text     String?
  url      String?
  color    String?
  metadata Json?
  order    Int            @default(0)
  layout   Json?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  board BucketVisionBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@index([boardId, type])
}

model BucketVisionGoalLink {
  id        Int      @id @default(autoincrement())
  boardId   Int
  goalId    Int
  label     String?
  createdAt DateTime @default(now())

  board BucketVisionBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  goal  BucketGoal        @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@unique([boardId, goalId])
  @@index([boardId])
  @@index([goalId])
}

model BucketVisionCheckin {
  id        Int      @id @default(autoincrement())
  boardId   Int
  kind      String?
  notes     String?
  mood      Json?
  snapshot  Json?
  createdAt DateTime @default(now())

  board BucketVisionBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@index([boardId, createdAt])
}
