generator client {
  provider = "prisma-client-js"
}

generator nestgraphql {
  provider = "node node_modules/prisma-nestjs-graphql"
  output   = "../@generated"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Storage {
  id         Int             @id @default(autoincrement())
  name       String
  members    StorageMember[] // ← Relacionamento M:N com usuários
  containers Container[]
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
}

model StorageMember {
  id        Int         @id @default(autoincrement())
  userId    Int
  storageId Int
  role      StorageRole @default(MEMBER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  storage Storage @relation(fields: [storageId], references: [id])

  @@unique([userId, storageId])
}

model Container {
  id          Int        @id @default(autoincrement())
  name        String
  description String
  qrCode      String // QR Code para identificação
  code        String     @unique // Código para identificação adicional
  storageId   Int
  storage     Storage    @relation(fields: [storageId], references: [id])
  categories  Category[] @relation("ContainerCategories")
  items       Item[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Item {
  id          Int       @id @default(autoincrement())
  name        String
  description String
  imageUrl    String // URL para a imagem do item
  quantity    Int
  category    String // Categoria adicional, se necessário
  containerId Int
  container   Container @relation(fields: [containerId], references: [id])
  
  // Transição para Discart-me
  donatedToDiscartMe Boolean   @default(false) // Indica se o item foi doado no Discart-me
  discartItemId      Int?      // ID do DiscartItem criado quando doado
  donatedAt          DateTime? // Data em que foi doado
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model DiscartItem {
  id          Int                  @id @default(autoincrement())
  title       String
  description String
  type        DiscartItemType
  price       Float?
  category    DiscartItemCategory  @default(OTHER)
  condition   DiscartItemCondition
  status      DiscartItemStatus    @default(ACTIVE)

  imageUrls     String[] @default([])
  pickupAddress Json? // { condoName, building, unit, notes }
  contactPhone  String? // ← agora opcional

  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])

  comments Comment[] // Comments on this item

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id          Int         @id @default(autoincrement())
  name        String
  description String?
  containers  Container[] @relation("ContainerCategories")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model User {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  password       String
  firstName      String
  lastName       String
  nickname       String?
  public         Boolean   @default(false)
  role           Role      @default(USER)
  emailVerified  Boolean   @default(false)
  profilePicture String?
  about          String?
  contactPhone   String? // ← NOVO CAMPO
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  isPremium      Boolean   @default(false)
  subscriptionId String? // LemonSqueezy ID
  expiresAt      DateTime?
  willExpireAt   DateTime? // Expiração futura agendada

  // Discart-me specific
  apartment          String?
  isApprovedResident Boolean @default(false)
  isAdmin            Boolean @default(false)

  storageMemberships StorageMember[]
  logs               Log[]

  discartItems       DiscartItem[]

  // Comments and Ratings
  comments        Comment[] @relation("CommentAuthor")
  ratingsAsSeller Rating[]  @relation("SellerRatings")
  ratingsAsBuyer  Rating[]  @relation("BuyerRatings")

  // Multi-app access
  apps            UserAppAccess[]

  // Wealth Tracker
  portfolios      Portfolio[]     @relation("UserPortfolios")
  refreshTokens   RefreshToken[]

  @@index([email], map: "userEmail")
}

model Log {
  id        Int       @id @default(autoincrement())
  action    LogAction
  userId    Int?
  user      User?     @relation(fields: [userId], references: [id])
  details   String?
  route     String? // Rota acessada (ex: "/dashboard" ou "/item/:id")
  metadata  Json? // Dados adicionais sobre o evento (ex: { itemId: 123, buttonName: "BuyNow" })
  ipAddress String?
  createdAt DateTime  @default(now())
}

enum LogAction {
  USER_LOGIN
  USER_LOGOUT
  ITEM_CREATED
  ITEM_UPDATED
  ITEM_DELETED
  CONTAINER_CREATED
  CONTAINER_DELETED
  BUTTON_CLICKED
  PAGE_VIEWED
  SEARCH_USED
  CUSTOM_ACTION
  REQUEST_PASSWORD_RESET
  PASSWORD_RESET
  USER_REGISTERED
  USER_PROFILE_UPDATED
  USER_DELETED
  STORAGE_CREATED
  STORAGE_DELETED
}

enum Role {
  USER
  ADMIN
}

enum DiscartItemType {
  SELL
  DONATE
}

enum DiscartItemCondition {
  NEW
  LIKE_NEW
  USED
}

enum DiscartItemStatus {
  ACTIVE
  RESERVED
  SOLD
  DONATED // ← NOVO STATUS
}

enum DiscartItemCategory {
  FURNITURE
  ELECTRONICS
  KIDS
  SPORTS
  OTHER
  BOOK
}

enum Visibility {
  PUBLIC
  PRIVATE
}

enum MembershipStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELED
}

enum TypeOfDeparture {
  VOLUNTARY
  INVOLUNTARY
  RETIREMENT
  OTHER // Quando selecionado "Outro", o campo `otherDetails` pode ser usado para especificação
}

enum StorageRole {
  ADMIN
  MEMBER
}

model Comment {
  id            Int      @id @default(autoincrement())
  content       String
  discartItemId Int
  userId        Int
  parentId      Int? // For replies (nested comments)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  discartItem DiscartItem @relation(fields: [discartItemId], references: [id], onDelete: Cascade)
  user        User        @relation("CommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  parent      Comment?    @relation("CommentParent", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[]   @relation("CommentParent")

  @@index([discartItemId])
  @@index([userId])
  @@index([parentId])
}

model Rating {
  id        Int      @id @default(autoincrement())
  sellerId  Int
  buyerId   Int
  stars     Int // 1-5
  comment   String?
  createdAt DateTime @default(now())

  seller User @relation("SellerRatings", fields: [sellerId], references: [id], onDelete: Cascade)
  buyer  User @relation("BuyerRatings", fields: [buyerId], references: [id], onDelete: Cascade)

  @@unique([sellerId, buyerId]) // Prevent duplicate ratings
  @@index([sellerId])
  @@index([buyerId])
}

model App {
  id          Int              @id @default(autoincrement())
  code        String           @unique
  name        String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  users       UserAppAccess[]
}

model UserAppAccess {
  id        Int   @id @default(autoincrement())
  userId    Int
  appId     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  app       App   @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@unique([userId, appId])
  @@index([userId])
  @@index([appId])
}

// ============================================
// Wealth Tracker Models
// ============================================

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique // Hashed refresh token
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Portfolio {
  id          Int          @id @default(autoincrement())
  userId      Int
  name        String
  baseCurrency String      @default("USD")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User         @relation("UserPortfolios", fields: [userId], references: [id], onDelete: Cascade)
  holdings    Holding[]
  transactions Transaction[]

  @@index([userId])
}

model Asset {
  id          Int          @id @default(autoincrement())
  type        AssetType
  ticker      String?     // Nullable for CASH/REAL_ESTATE
  name        String
  currency    String       @default("USD")
  exchange    String?
  metadata    Json?       // Additional metadata (e.g., sector, market cap)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  holdings    Holding[]
  pricePoints PricePoint[]
  transactions Transaction[] @relation("AssetTransactions")

  @@unique([type, ticker], name: "unique_asset_ticker")
  @@index([ticker])
  @@index([type])
}

model Holding {
  id          Int       @id @default(autoincrement())
  portfolioId Int
  assetId     Int
  quantity    Decimal   @db.Decimal(20, 8)
  averageCost Decimal   @db.Decimal(20, 8)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  asset       Asset     @relation(fields: [assetId], references: [id], onDelete: Restrict)

  @@index([portfolioId])
  @@index([assetId])
}

model PricePoint {
  id        Int       @id @default(autoincrement())
  assetId  Int
  price    Decimal   @db.Decimal(20, 8)
  currency String
  asOf     DateTime
  source   String    // Provider name (e.g., "mock", "yahoo")
  createdAt DateTime  @default(now())
  asset    Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, asOf])
  @@index([assetId, asOf])
  @@index([asOf])
}

model Transaction {
  id          Int          @id @default(autoincrement())
  portfolioId Int
  assetId     Int
  type        TransactionType
  quantity    Decimal      @db.Decimal(20, 8)
  price       Decimal      @db.Decimal(20, 8)
  fees        Decimal?     @db.Decimal(20, 8)
  notes       String?
  executedAt  DateTime     @default(now())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  portfolio   Portfolio    @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  asset       Asset        @relation("AssetTransactions", fields: [assetId], references: [id], onDelete: Restrict)

  @@index([portfolioId])
  @@index([assetId])
  @@index([executedAt])
}

enum AssetType {
  STOCK
  ETF
  CRYPTO
  CASH
  REAL_ESTATE
}

enum TransactionType {
  BUY
  SELL
}
